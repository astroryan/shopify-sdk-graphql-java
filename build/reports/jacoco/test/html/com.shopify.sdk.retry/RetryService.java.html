<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RetryService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.retry</a> &gt; <span class="el_source">RetryService.java</span></div><h1>RetryService.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.retry;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClientResponseException;
import reactor.core.publisher.Mono;
import reactor.util.retry.Retry;

import java.time.Duration;
import java.time.Instant;
import java.util.Random;
import java.util.function.Predicate;

/**
 * Service for handling automatic retries with exponential backoff.
 */
<span class="nc" id="L18">@Slf4j</span>
@Service
<span class="nc" id="L20">@RequiredArgsConstructor</span>
public class RetryService {
    
    private final RetryConfig config;
<span class="nc" id="L24">    private final Random random = new Random();</span>
    
    /**
     * Creates a retry spec for Shopify API calls.
     */
    public Retry createRetrySpec() {
<span class="nc bnc" id="L30" title="All 2 branches missed.">        if (!config.isEnabled()) {</span>
<span class="nc" id="L31">            return Retry.max(0);</span>
        }
        
<span class="nc" id="L34">        return Retry.backoff(config.getMaxAttempts(), config.getBaseDelay())</span>
<span class="nc" id="L35">            .maxBackoff(config.getMaxDelay())</span>
<span class="nc" id="L36">            .jitter(config.getJitterPercentage())</span>
<span class="nc" id="L37">            .filter(this::shouldRetry)</span>
<span class="nc" id="L38">            .onRetryExhaustedThrow((retryBackoffSpec, retrySignal) -&gt; {</span>
<span class="nc" id="L39">                log.error(&quot;Retry exhausted after {} attempts for operation: {}&quot;, </span>
<span class="nc" id="L40">                    retrySignal.totalRetries(), retrySignal.failure().getMessage());</span>
<span class="nc" id="L41">                return retrySignal.failure();</span>
            })
<span class="nc" id="L43">            .doBeforeRetry(retrySignal -&gt; {</span>
<span class="nc" id="L44">                Throwable failure = retrySignal.failure();</span>
<span class="nc" id="L45">                long attempt = retrySignal.totalRetries() + 1;</span>
                
<span class="nc" id="L47">                Duration delay = calculateDelay(attempt, failure);</span>
                
<span class="nc" id="L49">                log.warn(&quot;Retrying operation (attempt {}/{}) after {}ms due to: {}&quot;, </span>
<span class="nc" id="L50">                    attempt, config.getMaxAttempts(), delay.toMillis(), </span>
<span class="nc" id="L51">                    failure.getMessage());</span>
<span class="nc" id="L52">            });</span>
    }
    
    /**
     * Creates a custom retry spec with specific parameters.
     */
    public Retry createCustomRetrySpec(int maxAttempts, Duration baseDelay, Duration maxDelay) {
<span class="nc" id="L59">        return Retry.backoff(maxAttempts, baseDelay)</span>
<span class="nc" id="L60">            .maxBackoff(maxDelay)</span>
<span class="nc" id="L61">            .jitter(config.getJitterPercentage())</span>
<span class="nc" id="L62">            .filter(this::shouldRetry)</span>
<span class="nc" id="L63">            .doBeforeRetry(retrySignal -&gt; {</span>
<span class="nc" id="L64">                log.warn(&quot;Retrying operation (attempt {}/{}) due to: {}&quot;, </span>
<span class="nc" id="L65">                    retrySignal.totalRetries() + 1, maxAttempts, </span>
<span class="nc" id="L66">                    retrySignal.failure().getMessage());</span>
<span class="nc" id="L67">            });</span>
    }
    
    /**
     * Wraps a Mono with retry logic.
     */
    public &lt;T&gt; Mono&lt;T&gt; withRetry(Mono&lt;T&gt; mono) {
<span class="nc" id="L74">        return mono.retryWhen(createRetrySpec());</span>
    }
    
    /**
     * Wraps a Mono with custom retry logic.
     */
    public &lt;T&gt; Mono&lt;T&gt; withCustomRetry(Mono&lt;T&gt; mono, int maxAttempts, Duration baseDelay) {
<span class="nc" id="L81">        return mono.retryWhen(createCustomRetrySpec(maxAttempts, baseDelay, config.getMaxDelay()));</span>
    }
    
    /**
     * Determines if an exception should trigger a retry.
     */
    private boolean shouldRetry(Throwable throwable) {
        // Check for retryable exception types
<span class="nc bnc" id="L89" title="All 2 branches missed.">        for (Class&lt;? extends Throwable&gt; retryableException : config.getRetryableExceptions()) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            if (retryableException.isAssignableFrom(throwable.getClass())) {</span>
<span class="nc" id="L91">                log.debug(&quot;Exception {} is retryable (type match)&quot;, throwable.getClass().getSimpleName());</span>
<span class="nc" id="L92">                return true;</span>
            }
<span class="nc" id="L94">        }</span>
        
        // Check for retryable HTTP status codes
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (throwable instanceof WebClientResponseException) {</span>
<span class="nc" id="L98">            WebClientResponseException webEx = (WebClientResponseException) throwable;</span>
<span class="nc" id="L99">            int statusCode = webEx.getStatusCode().value();</span>
            
<span class="nc" id="L101">            boolean isRetryable = config.getRetryableStatusCodes().contains(statusCode);</span>
            
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (isRetryable) {</span>
<span class="nc" id="L104">                log.debug(&quot;HTTP status {} is retryable&quot;, statusCode);</span>
            } else {
<span class="nc" id="L106">                log.debug(&quot;HTTP status {} is not retryable&quot;, statusCode);</span>
            }
            
<span class="nc" id="L109">            return isRetryable;</span>
        }
        
<span class="nc" id="L112">        log.debug(&quot;Exception {} is not retryable&quot;, throwable.getClass().getSimpleName());</span>
<span class="nc" id="L113">        return false;</span>
    }
    
    /**
     * Calculates the delay for a retry attempt.
     */
    private Duration calculateDelay(long attemptNumber, Throwable failure) {
<span class="nc" id="L120">        Duration baseDelay = config.getBaseDelay();</span>
        
        // Check for Retry-After header in HTTP responses
<span class="nc bnc" id="L123" title="All 4 branches missed.">        if (config.isRespectRetryAfterHeader() &amp;&amp; failure instanceof WebClientResponseException) {</span>
<span class="nc" id="L124">            WebClientResponseException webEx = (WebClientResponseException) failure;</span>
<span class="nc" id="L125">            String retryAfter = webEx.getHeaders().getFirst(&quot;Retry-After&quot;);</span>
            
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (retryAfter != null) {</span>
                try {
<span class="nc" id="L129">                    long retryAfterSeconds = Long.parseLong(retryAfter);</span>
<span class="nc" id="L130">                    Duration retryAfterDuration = Duration.ofSeconds(retryAfterSeconds);</span>
                    
<span class="nc" id="L132">                    log.debug(&quot;Using Retry-After header value: {}s&quot;, retryAfterSeconds);</span>
                    
                    // Respect the server's suggestion but cap at max delay
<span class="nc bnc" id="L135" title="All 2 branches missed.">                    return retryAfterDuration.compareTo(config.getMaxDelay()) &lt;= 0 ? </span>
<span class="nc" id="L136">                        retryAfterDuration : config.getMaxDelay();</span>
                        
<span class="nc" id="L138">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L139">                    log.warn(&quot;Invalid Retry-After header value: {}&quot;, retryAfter);</span>
                }
            }
        }
        
        // Use exponential backoff if enabled
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (config.isUseExponentialBackoff()) {</span>
<span class="nc" id="L146">            long delayMs = (long) (baseDelay.toMillis() * Math.pow(config.getBackoffMultiplier(), attemptNumber - 1));</span>
<span class="nc" id="L147">            baseDelay = Duration.ofMillis(delayMs);</span>
        }
        
        // Cap at max delay
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (baseDelay.compareTo(config.getMaxDelay()) &gt; 0) {</span>
<span class="nc" id="L152">            baseDelay = config.getMaxDelay();</span>
        }
        
        // Add jitter to prevent thundering herd
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (config.getJitterPercentage() &gt; 0) {</span>
<span class="nc" id="L157">            long jitterMs = (long) (baseDelay.toMillis() * config.getJitterPercentage() * random.nextDouble());</span>
<span class="nc" id="L158">            baseDelay = baseDelay.plusMillis(jitterMs);</span>
        }
        
<span class="nc" id="L161">        return baseDelay;</span>
    }
    
    /**
     * Creates a predicate to filter retryable exceptions.
     */
    public Predicate&lt;Throwable&gt; retryablePredicate() {
<span class="nc" id="L168">        return this::shouldRetry;</span>
    }
    
    /**
     * Gets the retry configuration.
     */
    public RetryConfig getConfig() {
<span class="nc" id="L175">        return config;</span>
    }
    
    /**
     * Creates a retry context for tracking retry attempts.
     */
    public RetryContext createContext(String operationName) {
<span class="nc" id="L182">        return new RetryContext(operationName);</span>
    }
    
    /**
     * Context for tracking retry attempts.
     */
    public static class RetryContext {
        private final String operationName;
        private final Instant startTime;
<span class="nc" id="L191">        private int attemptCount = 0;</span>
<span class="nc" id="L192">        private Duration totalDelay = Duration.ZERO;</span>
        
<span class="nc" id="L194">        public RetryContext(String operationName) {</span>
<span class="nc" id="L195">            this.operationName = operationName;</span>
<span class="nc" id="L196">            this.startTime = Instant.now();</span>
<span class="nc" id="L197">        }</span>
        
        public void recordAttempt(Duration delay) {
<span class="nc" id="L200">            attemptCount++;</span>
<span class="nc" id="L201">            totalDelay = totalDelay.plus(delay);</span>
<span class="nc" id="L202">        }</span>
        
        public String getOperationName() {
<span class="nc" id="L205">            return operationName;</span>
        }
        
        public int getAttemptCount() {
<span class="nc" id="L209">            return attemptCount;</span>
        }
        
        public Duration getTotalDelay() {
<span class="nc" id="L213">            return totalDelay;</span>
        }
        
        public Duration getTotalTime() {
<span class="nc" id="L217">            return Duration.between(startTime, Instant.now());</span>
        }
        
        public Instant getStartTime() {
<span class="nc" id="L221">            return startTime;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>