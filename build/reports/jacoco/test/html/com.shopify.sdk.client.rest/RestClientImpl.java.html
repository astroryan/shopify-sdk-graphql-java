<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RestClientImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.client.rest</a> &gt; <span class="el_source">RestClientImpl.java</span></div><h1>RestClientImpl.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.client.rest;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.shopify.sdk.client.HttpClientConfig;
import com.shopify.sdk.exception.ShopifyApiException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.util.UriComponentsBuilder;
import reactor.core.publisher.Mono;

import java.util.Map;

/**
 * Implementation of RestClient for making REST API calls to Shopify.
 */
<span class="nc" id="L20">@Slf4j</span>
@Component
<span class="nc" id="L22">@RequiredArgsConstructor</span>
public class RestClientImpl implements RestClient {
    
    private final HttpClientConfig httpClientConfig;
    private final ObjectMapper objectMapper;
    
    @Override
    public Mono&lt;JsonNode&gt; get(String shop, String accessToken, String endpoint, Map&lt;String, Object&gt; queryParams) {
<span class="nc" id="L30">        String url = buildShopifyUrl(shop, endpoint);</span>
        
<span class="nc" id="L32">        UriComponentsBuilder uriBuilder = UriComponentsBuilder.fromHttpUrl(url);</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">        if (queryParams != null) {</span>
<span class="nc" id="L34">            queryParams.forEach((key, value) -&gt; {</span>
<span class="nc bnc" id="L35" title="All 2 branches missed.">                if (value != null) {</span>
<span class="nc" id="L36">                    uriBuilder.queryParam(key, value);</span>
                }
<span class="nc" id="L38">            });</span>
        }
        
<span class="nc" id="L41">        return httpClientConfig.getWebClient()</span>
<span class="nc" id="L42">            .get()</span>
<span class="nc" id="L43">            .uri(uriBuilder.build().toUri())</span>
<span class="nc" id="L44">            .header(&quot;X-Shopify-Access-Token&quot;, accessToken)</span>
<span class="nc" id="L45">            .header(&quot;User-Agent&quot;, httpClientConfig.getUserAgent())</span>
<span class="nc" id="L46">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L47">            .retrieve()</span>
<span class="nc" id="L48">            .bodyToMono(String.class)</span>
<span class="nc" id="L49">            .map(this::parseResponse)</span>
<span class="nc" id="L50">            .doOnError(error -&gt; log.error(&quot;GET request failed for endpoint: {}&quot;, endpoint, error))</span>
<span class="nc" id="L51">            .onErrorMap(this::mapToShopifyApiException);</span>
    }
    
    @Override
    public Mono&lt;JsonNode&gt; post(String shop, String accessToken, String endpoint, Object body) {
<span class="nc" id="L56">        String url = buildShopifyUrl(shop, endpoint);</span>
        
<span class="nc" id="L58">        return httpClientConfig.getWebClient()</span>
<span class="nc" id="L59">            .post()</span>
<span class="nc" id="L60">            .uri(url)</span>
<span class="nc" id="L61">            .header(&quot;X-Shopify-Access-Token&quot;, accessToken)</span>
<span class="nc" id="L62">            .header(&quot;User-Agent&quot;, httpClientConfig.getUserAgent())</span>
<span class="nc" id="L63">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L64">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            .bodyValue(body != null ? body : &quot;{}&quot;)</span>
<span class="nc" id="L66">            .retrieve()</span>
<span class="nc" id="L67">            .bodyToMono(String.class)</span>
<span class="nc" id="L68">            .map(this::parseResponse)</span>
<span class="nc" id="L69">            .doOnError(error -&gt; log.error(&quot;POST request failed for endpoint: {}&quot;, endpoint, error))</span>
<span class="nc" id="L70">            .onErrorMap(this::mapToShopifyApiException);</span>
    }
    
    @Override
    public Mono&lt;JsonNode&gt; put(String shop, String accessToken, String endpoint, Object body) {
<span class="nc" id="L75">        String url = buildShopifyUrl(shop, endpoint);</span>
        
<span class="nc" id="L77">        return httpClientConfig.getWebClient()</span>
<span class="nc" id="L78">            .put()</span>
<span class="nc" id="L79">            .uri(url)</span>
<span class="nc" id="L80">            .header(&quot;X-Shopify-Access-Token&quot;, accessToken)</span>
<span class="nc" id="L81">            .header(&quot;User-Agent&quot;, httpClientConfig.getUserAgent())</span>
<span class="nc" id="L82">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L83">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            .bodyValue(body != null ? body : &quot;{}&quot;)</span>
<span class="nc" id="L85">            .retrieve()</span>
<span class="nc" id="L86">            .bodyToMono(String.class)</span>
<span class="nc" id="L87">            .map(this::parseResponse)</span>
<span class="nc" id="L88">            .doOnError(error -&gt; log.error(&quot;PUT request failed for endpoint: {}&quot;, endpoint, error))</span>
<span class="nc" id="L89">            .onErrorMap(this::mapToShopifyApiException);</span>
    }
    
    @Override
    public Mono&lt;JsonNode&gt; delete(String shop, String accessToken, String endpoint) {
<span class="nc" id="L94">        String url = buildShopifyUrl(shop, endpoint);</span>
        
<span class="nc" id="L96">        return httpClientConfig.getWebClient()</span>
<span class="nc" id="L97">            .delete()</span>
<span class="nc" id="L98">            .uri(url)</span>
<span class="nc" id="L99">            .header(&quot;X-Shopify-Access-Token&quot;, accessToken)</span>
<span class="nc" id="L100">            .header(&quot;User-Agent&quot;, httpClientConfig.getUserAgent())</span>
<span class="nc" id="L101">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L102">            .retrieve()</span>
<span class="nc" id="L103">            .bodyToMono(String.class)</span>
<span class="nc" id="L104">            .map(this::parseResponse)</span>
<span class="nc" id="L105">            .doOnError(error -&gt; log.error(&quot;DELETE request failed for endpoint: {}&quot;, endpoint, error))</span>
<span class="nc" id="L106">            .onErrorMap(this::mapToShopifyApiException);</span>
    }
    
    private String buildShopifyUrl(String shop, String endpoint) {
<span class="nc" id="L110">        String baseUrl = String.format(&quot;https://%s.myshopify.com/admin/api/2024-01&quot;, </span>
<span class="nc" id="L111">            shop.replace(&quot;.myshopify.com&quot;, &quot;&quot;));</span>
        
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (!endpoint.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L114">            endpoint = &quot;/&quot; + endpoint;</span>
        }
        
<span class="nc" id="L117">        return baseUrl + endpoint;</span>
    }
    
    private JsonNode parseResponse(String responseBody) {
        try {
<span class="nc bnc" id="L122" title="All 4 branches missed.">            if (responseBody == null || responseBody.trim().isEmpty()) {</span>
<span class="nc" id="L123">                return objectMapper.createObjectNode();</span>
            }
<span class="nc" id="L125">            return objectMapper.readTree(responseBody);</span>
<span class="nc" id="L126">        } catch (Exception e) {</span>
<span class="nc" id="L127">            log.error(&quot;Failed to parse response body: {}&quot;, responseBody, e);</span>
<span class="nc" id="L128">            throw new ShopifyApiException(&quot;Failed to parse REST API response&quot;, e);</span>
        }
    }
    
    private Throwable mapToShopifyApiException(Throwable throwable) {
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (throwable instanceof ShopifyApiException) {</span>
<span class="nc" id="L134">            return throwable;</span>
        }
<span class="nc" id="L136">        return new ShopifyApiException(&quot;REST API request failed&quot;, throwable);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>