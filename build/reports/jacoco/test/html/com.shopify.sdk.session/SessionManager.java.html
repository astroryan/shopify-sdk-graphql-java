<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.session</a> &gt; <span class="el_source">SessionManager.java</span></div><h1>SessionManager.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.session;

import com.shopify.sdk.auth.AccessTokenResponse;
import com.shopify.sdk.auth.JwtClaims;
import com.shopify.sdk.auth.JwtTokenValidator;
import com.shopify.sdk.exception.ShopifyApiException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

import java.time.Instant;
import java.util.Arrays;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;

/**
 * Service for managing Shopify sessions.
 */
<span class="fc" id="L21">@Slf4j</span>
@Service
<span class="fc" id="L23">@RequiredArgsConstructor</span>
public class SessionManager {
    
    private final SessionStore sessionStore;
    private final JwtTokenValidator jwtTokenValidator;
    
    /**
     * Creates a new session from an access token response.
     *
     * @param shop the shop domain
     * @param accessTokenResponse the access token response
     * @param isOnline whether this is an online session
     * @return Mono containing the created session
     */
    public Mono&lt;ShopifySession&gt; createSession(String shop, AccessTokenResponse accessTokenResponse, boolean isOnline) {
<span class="fc" id="L38">        return Mono.fromSupplier(() -&gt; {</span>
<span class="fc" id="L39">            ShopifySession.ShopifySessionBuilder sessionBuilder = ShopifySession.builder()</span>
<span class="fc" id="L40">                .shop(normalizeShop(shop))</span>
<span class="fc" id="L41">                .accessToken(accessTokenResponse.getAccessToken())</span>
<span class="fc" id="L42">                .isOnline(isOnline)</span>
<span class="fc" id="L43">                .createdAt(Instant.now())</span>
<span class="fc" id="L44">                .updatedAt(Instant.now());</span>
            
            // Parse scopes
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            if (accessTokenResponse.getScope() != null) {</span>
<span class="fc" id="L48">                String[] scopes = accessTokenResponse.getScope().split(&quot;,&quot;);</span>
<span class="fc" id="L49">                sessionBuilder.scope(new HashSet&lt;&gt;(Arrays.asList(scopes)));</span>
            }
            
            // Set user information for online sessions
<span class="pc bpc" id="L53" title="2 of 4 branches missed.">            if (isOnline &amp;&amp; accessTokenResponse.getAssociatedUser() != null) {</span>
<span class="nc" id="L54">                AccessTokenResponse.AssociatedUser user = accessTokenResponse.getAssociatedUser();</span>
<span class="nc" id="L55">                sessionBuilder</span>
<span class="nc" id="L56">                    .userId(user.getId())</span>
<span class="nc" id="L57">                    .userEmail(user.getEmail())</span>
<span class="nc" id="L58">                    .userFirstName(user.getFirstName())</span>
<span class="nc" id="L59">                    .userLastName(user.getLastName())</span>
<span class="nc" id="L60">                    .userEmailVerified(user.getEmailVerified())</span>
<span class="nc" id="L61">                    .accountOwner(user.getAccountOwner())</span>
<span class="nc" id="L62">                    .collaborator(user.getCollaborator())</span>
<span class="nc" id="L63">                    .userLocale(user.getLocale());</span>
                    
                // Set expiration for online tokens (typically 24 hours)
<span class="nc" id="L66">                sessionBuilder.expiresAt(Instant.now().plusSeconds(86400));</span>
            }
            
<span class="fc" id="L69">            return sessionBuilder.build();</span>
        })
<span class="fc" id="L71">        .flatMap(session -&gt; {</span>
<span class="fc" id="L72">            session.setId(ShopifySession.createSessionId(session.getShop(), session.isOnline(), session.getUserId()));</span>
<span class="fc" id="L73">            return sessionStore.storeSession(session)</span>
<span class="fc" id="L74">                .thenReturn(session);</span>
        });
    }
    
    /**
     * Creates a session from a JWT token.
     *
     * @param jwtToken the JWT token
     * @param accessToken the access token (optional, can be extracted later)
     * @return Mono containing the created session
     */
    public Mono&lt;ShopifySession&gt; createSessionFromJwt(String jwtToken, String accessToken) {
<span class="fc" id="L86">        return Mono.fromSupplier(() -&gt; jwtTokenValidator.validateToken(jwtToken))</span>
<span class="fc" id="L87">            .map(jwtClaims -&gt; {</span>
<span class="fc" id="L88">                ShopifySession.ShopifySessionBuilder sessionBuilder = ShopifySession.builder()</span>
<span class="fc" id="L89">                    .shop(normalizeShop(jwtClaims.getShop()))</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">                    .isOnline(jwtClaims.getUserId() != null)</span>
<span class="fc" id="L91">                    .createdAt(Instant.now())</span>
<span class="fc" id="L92">                    .updatedAt(Instant.now());</span>
                
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">                if (accessToken != null) {</span>
<span class="fc" id="L95">                    sessionBuilder.accessToken(accessToken);</span>
                }
                
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">                if (jwtClaims.getUserId() != null) {</span>
<span class="fc" id="L99">                    sessionBuilder</span>
<span class="fc" id="L100">                        .userId(jwtClaims.getUserId())</span>
<span class="fc" id="L101">                        .expiresAt(jwtClaims.getExpiration());</span>
                }
                
<span class="fc" id="L104">                ShopifySession session = sessionBuilder.build();</span>
<span class="fc" id="L105">                session.setId(ShopifySession.createSessionId(session.getShop(), session.isOnline(), session.getUserId()));</span>
                
<span class="fc" id="L107">                return session;</span>
            })
<span class="fc" id="L109">            .flatMap(session -&gt; sessionStore.storeSession(session).thenReturn(session));</span>
    }
    
    /**
     * Gets a session by ID.
     *
     * @param sessionId the session ID
     * @return Mono containing the session if found and valid
     */
    public Mono&lt;ShopifySession&gt; getSession(String sessionId) {
<span class="fc" id="L119">        return sessionStore.loadSession(sessionId)</span>
<span class="fc" id="L120">            .map(optionalSession -&gt; optionalSession.orElse(null))</span>
<span class="pc bpc" id="L121" title="2 of 4 branches missed.">            .filter(session -&gt; session != null &amp;&amp; session.isValid());</span>
    }
    
    /**
     * Gets a session for a shop and user (for online sessions) or just shop (for offline sessions).
     *
     * @param shop the shop domain
     * @param isOnline whether to look for online session
     * @param userId the user ID (required for online sessions)
     * @return Mono containing the session if found and valid
     */
    public Mono&lt;ShopifySession&gt; getSessionForShop(String shop, boolean isOnline, Long userId) {
<span class="nc" id="L133">        String sessionId = ShopifySession.createSessionId(normalizeShop(shop), isOnline, userId);</span>
<span class="nc" id="L134">        return getSession(sessionId);</span>
    }
    
    /**
     * Gets the offline session for a shop.
     *
     * @param shop the shop domain
     * @return Mono containing the offline session if found and valid
     */
    public Mono&lt;ShopifySession&gt; getOfflineSession(String shop) {
<span class="nc" id="L144">        return getSessionForShop(shop, false, null);</span>
    }
    
    /**
     * Gets all sessions for a shop.
     *
     * @param shop the shop domain
     * @return Mono containing list of sessions for the shop
     */
    public Mono&lt;List&lt;ShopifySession&gt;&gt; getSessionsForShop(String shop) {
<span class="fc" id="L154">        return sessionStore.findSessionsByShop(normalizeShop(shop));</span>
    }
    
    /**
     * Updates a session.
     *
     * @param session the session to update
     * @return Mono that completes when the session is updated
     */
    public Mono&lt;Void&gt; updateSession(ShopifySession session) {
<span class="nc" id="L164">        return sessionStore.updateSession(session);</span>
    }
    
    /**
     * Deletes a session.
     *
     * @param sessionId the session ID
     * @return Mono that completes when the session is deleted
     */
    public Mono&lt;Void&gt; deleteSession(String sessionId) {
<span class="fc" id="L174">        return sessionStore.deleteSession(sessionId);</span>
    }
    
    /**
     * Deletes all sessions for a shop.
     *
     * @param shop the shop domain
     * @return Mono that completes when all sessions are deleted
     */
    public Mono&lt;Void&gt; deleteSessionsForShop(String shop) {
<span class="fc" id="L184">        return sessionStore.deleteSessionsByShop(normalizeShop(shop));</span>
    }
    
    /**
     * Validates a session and returns it if valid.
     *
     * @param sessionId the session ID
     * @return Mono containing the session if valid, or error if invalid
     */
    public Mono&lt;ShopifySession&gt; validateSession(String sessionId) {
<span class="nc" id="L194">        return getSession(sessionId)</span>
<span class="nc" id="L195">            .switchIfEmpty(Mono.error(new ShopifyApiException(&quot;Invalid or expired session: &quot; + sessionId)));</span>
    }
    
    /**
     * Validates that a session has the required scopes.
     *
     * @param session the session to validate
     * @param requiredScopes the required scopes
     * @return Mono containing the session if valid, or error if insufficient scopes
     */
    public Mono&lt;ShopifySession&gt; validateSessionScopes(ShopifySession session, List&lt;String&gt; requiredScopes) {
<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (session.hasAllScopes(requiredScopes)) {</span>
<span class="nc" id="L207">            return Mono.just(session);</span>
        } else {
<span class="nc" id="L209">            return Mono.error(new ShopifyApiException(&quot;Insufficient scopes. Required: &quot; + requiredScopes + </span>
<span class="nc" id="L210">                &quot;, Available: &quot; + session.getScope()));</span>
        }
    }
    
    /**
     * Refreshes a session's updated timestamp.
     *
     * @param sessionId the session ID
     * @return Mono that completes when the session is refreshed
     */
    public Mono&lt;Void&gt; touchSession(String sessionId) {
<span class="nc" id="L221">        return getSession(sessionId)</span>
<span class="nc" id="L222">            .doOnNext(ShopifySession::touch)</span>
<span class="nc" id="L223">            .flatMap(this::updateSession);</span>
    }
    
    /**
     * Cleans up expired sessions.
     *
     * @return Mono containing the number of deleted sessions
     */
    public Mono&lt;Long&gt; cleanupExpiredSessions() {
<span class="nc" id="L232">        return sessionStore.deleteExpiredSessions();</span>
    }
    
    /**
     * Gets session statistics.
     *
     * @return Mono containing session statistics
     */
    public Mono&lt;SessionStats&gt; getSessionStats() {
<span class="nc" id="L241">        return Mono.zip(</span>
<span class="nc" id="L242">            sessionStore.getSessionCount(),</span>
<span class="nc" id="L243">            sessionStore.findActiveSessions().map(sessions -&gt; (long) sessions.size()),</span>
<span class="nc" id="L244">            sessionStore.deleteExpiredSessions()</span>
<span class="nc" id="L245">        ).map(tuple -&gt; SessionStats.builder()</span>
<span class="nc" id="L246">            .totalSessions(tuple.getT1())</span>
<span class="nc" id="L247">            .activeSessions(tuple.getT2())</span>
<span class="nc" id="L248">            .expiredSessions(tuple.getT3())</span>
<span class="nc" id="L249">            .build());</span>
    }
    
    private String normalizeShop(String shop) {
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (shop == null) {</span>
<span class="nc" id="L254">            return null;</span>
        }
        
<span class="fc" id="L257">        return shop.toLowerCase()</span>
<span class="fc" id="L258">            .replace(&quot;https://&quot;, &quot;&quot;)</span>
<span class="fc" id="L259">            .replace(&quot;http://&quot;, &quot;&quot;)</span>
<span class="fc" id="L260">            .replace(&quot;.myshopify.com&quot;, &quot;&quot;);</span>
    }
    
    /**
     * Session statistics data class.
     */
<span class="nc bnc" id="L266" title="All 30 branches missed.">    @lombok.Data</span>
<span class="nc" id="L267">    @lombok.Builder</span>
<span class="nc" id="L268">    @lombok.NoArgsConstructor</span>
<span class="nc" id="L269">    @lombok.AllArgsConstructor</span>
    public static class SessionStats {
<span class="nc" id="L271">        private Long totalSessions;</span>
<span class="nc" id="L272">        private Long activeSessions;</span>
<span class="nc" id="L273">        private Long expiredSessions;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>