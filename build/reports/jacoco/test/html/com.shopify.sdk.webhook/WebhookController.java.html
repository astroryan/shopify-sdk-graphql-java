<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebhookController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.webhook</a> &gt; <span class="el_source">WebhookController.java</span></div><h1>WebhookController.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.webhook;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

import jakarta.servlet.http.HttpServletRequest;
import java.util.Collections;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Map;

/**
 * REST controller for handling Shopify webhook endpoints.
 * This controller is only enabled if the property shopify.webhook.enabled is true.
 */
<span class="nc" id="L22">@Slf4j</span>
@RestController
@RequestMapping(&quot;/webhooks/shopify&quot;)
<span class="nc" id="L25">@RequiredArgsConstructor</span>
@ConditionalOnProperty(name = &quot;shopify.webhook.enabled&quot;, havingValue = &quot;true&quot;, matchIfMissing = false)
public class WebhookController {
    
    private final WebhookProcessor webhookProcessor;
    
    /**
     * Handles webhook requests from Shopify.
     *
     * @param requestBody the raw request body
     * @param request the HTTP request for header extraction
     * @return ResponseEntity with processing result
     */
    @PostMapping(
        value = {&quot;&quot;, &quot;/&quot;},
        consumes = {MediaType.APPLICATION_JSON_VALUE, MediaType.TEXT_PLAIN_VALUE, MediaType.ALL_VALUE}
    )
    public Mono&lt;ResponseEntity&lt;String&gt;&gt; handleWebhook(
            @RequestBody String requestBody,
            HttpServletRequest request) {
        
<span class="nc" id="L46">        Map&lt;String, String&gt; headers = extractHeaders(request);</span>
<span class="nc" id="L47">        String topic = headers.get(&quot;X-Shopify-Topic&quot;);</span>
<span class="nc" id="L48">        String shop = headers.get(&quot;X-Shopify-Shop-Domain&quot;);</span>
        
<span class="nc" id="L50">        log.info(&quot;Received webhook: {} from shop: {}&quot;, topic, shop);</span>
        
<span class="nc" id="L52">        return webhookProcessor.processWebhook(requestBody, headers)</span>
<span class="nc" id="L53">            .map(event -&gt; {</span>
<span class="nc" id="L54">                log.debug(&quot;Successfully processed webhook: {}&quot;, event.getId());</span>
<span class="nc" id="L55">                return ResponseEntity.ok(&quot;Webhook processed successfully&quot;);</span>
            })
<span class="nc" id="L57">            .onErrorResume(error -&gt; {</span>
<span class="nc" id="L58">                log.error(&quot;Failed to process webhook: {} from shop: {}&quot;, topic, shop, error);</span>
<span class="nc" id="L59">                return Mono.just(ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L60">                    .body(&quot;Failed to process webhook: &quot; + error.getMessage()));</span>
            });
    }
    
    /**
     * Handles webhook requests with verification disabled (for testing).
     *
     * @param requestBody the raw request body
     * @param request the HTTP request for header extraction
     * @return ResponseEntity with processing result
     */
    @PostMapping(
        value = &quot;/test&quot;,
        consumes = {MediaType.APPLICATION_JSON_VALUE, MediaType.TEXT_PLAIN_VALUE, MediaType.ALL_VALUE}
    )
    public Mono&lt;ResponseEntity&lt;String&gt;&gt; handleTestWebhook(
            @RequestBody String requestBody,
            HttpServletRequest request) {
        
<span class="nc" id="L79">        Map&lt;String, String&gt; headers = extractHeaders(request);</span>
<span class="nc" id="L80">        String topic = headers.get(&quot;X-Shopify-Topic&quot;);</span>
<span class="nc" id="L81">        String shop = headers.get(&quot;X-Shopify-Shop-Domain&quot;);</span>
        
<span class="nc" id="L83">        log.info(&quot;Received test webhook: {} from shop: {}&quot;, topic, shop);</span>
        
<span class="nc" id="L85">        return webhookProcessor.processWebhookWithoutVerification(requestBody, headers)</span>
<span class="nc" id="L86">            .map(event -&gt; {</span>
<span class="nc" id="L87">                log.debug(&quot;Successfully processed test webhook: {}&quot;, event.getId());</span>
<span class="nc" id="L88">                return ResponseEntity.ok(&quot;Test webhook processed successfully&quot;);</span>
            })
<span class="nc" id="L90">            .onErrorResume(error -&gt; {</span>
<span class="nc" id="L91">                log.error(&quot;Failed to process test webhook: {} from shop: {}&quot;, topic, shop, error);</span>
<span class="nc" id="L92">                return Mono.just(ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L93">                    .body(&quot;Failed to process test webhook: &quot; + error.getMessage()));</span>
            });
    }
    
    /**
     * Handles webhook verification requests from Shopify.
     * This endpoint is used by Shopify to verify that the webhook endpoint is reachable.
     *
     * @param request the HTTP request
     * @return ResponseEntity confirming the endpoint is reachable
     */
    @GetMapping({&quot;&quot;, &quot;/&quot;})
    public ResponseEntity&lt;String&gt; verifyWebhookEndpoint(HttpServletRequest request) {
<span class="nc" id="L106">        String challenge = request.getParameter(&quot;hub.challenge&quot;);</span>
        
<span class="nc bnc" id="L108" title="All 4 branches missed.">        if (challenge != null &amp;&amp; !challenge.trim().isEmpty()) {</span>
<span class="nc" id="L109">            log.debug(&quot;Responding to webhook verification challenge&quot;);</span>
<span class="nc" id="L110">            return ResponseEntity.ok(challenge);</span>
        }
        
<span class="nc" id="L113">        return ResponseEntity.ok(&quot;Shopify webhook endpoint is active&quot;);</span>
    }
    
    /**
     * Gets webhook processing statistics.
     *
     * @return webhook statistics
     */
    @GetMapping(&quot;/stats&quot;)
    public ResponseEntity&lt;WebhookProcessor.WebhookStats&gt; getWebhookStats() {
<span class="nc" id="L123">        return ResponseEntity.ok(webhookProcessor.getStats());</span>
    }
    
    /**
     * Resets webhook processing statistics.
     *
     * @return confirmation message
     */
    @PostMapping(&quot;/stats/reset&quot;)
    public ResponseEntity&lt;String&gt; resetWebhookStats() {
<span class="nc" id="L133">        webhookProcessor.resetStats();</span>
<span class="nc" id="L134">        return ResponseEntity.ok(&quot;Webhook statistics reset successfully&quot;);</span>
    }
    
    /**
     * Health check endpoint for the webhook service.
     *
     * @return health status
     */
    @GetMapping(&quot;/health&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; healthCheck() {
<span class="nc" id="L144">        Map&lt;String, Object&gt; health = new HashMap&lt;&gt;();</span>
<span class="nc" id="L145">        health.put(&quot;status&quot;, &quot;UP&quot;);</span>
<span class="nc" id="L146">        health.put(&quot;service&quot;, &quot;Shopify Webhook Handler&quot;);</span>
<span class="nc" id="L147">        health.put(&quot;timestamp&quot;, System.currentTimeMillis());</span>
        
<span class="nc" id="L149">        WebhookProcessor.WebhookStats stats = webhookProcessor.getStats();</span>
<span class="nc" id="L150">        health.put(&quot;totalReceived&quot;, stats.getTotalReceived());</span>
<span class="nc" id="L151">        health.put(&quot;totalProcessed&quot;, stats.getTotalProcessed());</span>
<span class="nc" id="L152">        health.put(&quot;totalFailed&quot;, stats.getTotalFailed());</span>
<span class="nc" id="L153">        health.put(&quot;successRate&quot;, String.format(&quot;%.2f%%&quot;, stats.getSuccessRate()));</span>
        
<span class="nc" id="L155">        return ResponseEntity.ok(health);</span>
    }
    
    private Map&lt;String, String&gt; extractHeaders(HttpServletRequest request) {
<span class="nc" id="L159">        Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();</span>
        
<span class="nc" id="L161">        Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">        if (headerNames != null) {</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">            while (headerNames.hasMoreElements()) {</span>
<span class="nc" id="L164">                String headerName = headerNames.nextElement();</span>
<span class="nc" id="L165">                String headerValue = request.getHeader(headerName);</span>
<span class="nc" id="L166">                headers.put(headerName, headerValue);</span>
<span class="nc" id="L167">            }</span>
        }
        
        // Add some additional useful request information
<span class="nc" id="L171">        headers.put(&quot;Remote-Addr&quot;, request.getRemoteAddr());</span>
<span class="nc" id="L172">        headers.put(&quot;Request-URI&quot;, request.getRequestURI());</span>
<span class="nc" id="L173">        headers.put(&quot;Content-Length&quot;, String.valueOf(request.getContentLength()));</span>
        
<span class="nc" id="L175">        return headers;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>