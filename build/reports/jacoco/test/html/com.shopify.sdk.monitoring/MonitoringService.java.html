<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MonitoringService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.monitoring</a> &gt; <span class="el_source">MonitoringService.java</span></div><h1>MonitoringService.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.monitoring;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.Instant;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

/**
 * Service for monitoring Shopify API usage and performance.
 */
<span class="nc" id="L17">@Slf4j</span>
@Service
public class MonitoringService {
    
<span class="nc" id="L21">    private final Map&lt;String, ApiMetrics&gt; metricsMap = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L22">    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);</span>
<span class="nc" id="L23">    private volatile boolean monitoringEnabled = true;</span>
    
    // Default metrics for overall API usage
    private static final String GLOBAL_METRICS_KEY = &quot;global&quot;;
    private static final String REST_METRICS_KEY = &quot;rest&quot;;
    private static final String GRAPHQL_METRICS_KEY = &quot;graphql&quot;;
    
<span class="nc" id="L30">    public MonitoringService() {</span>
        // Initialize default metrics
<span class="nc" id="L32">        metricsMap.put(GLOBAL_METRICS_KEY, new ApiMetrics());</span>
<span class="nc" id="L33">        metricsMap.put(REST_METRICS_KEY, new ApiMetrics());</span>
<span class="nc" id="L34">        metricsMap.put(GRAPHQL_METRICS_KEY, new ApiMetrics());</span>
        
        // Start periodic reporting
<span class="nc" id="L37">        startPeriodicReporting();</span>
<span class="nc" id="L38">    }</span>
    
    /**
     * Records a REST API request start.
     */
    public void recordRestRequest() {
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L46">        getGlobalMetrics().recordRequest();</span>
<span class="nc" id="L47">        getRestMetrics().recordRequest();</span>
<span class="nc" id="L48">    }</span>
    
    /**
     * Records a GraphQL API request start.
     */
    public void recordGraphQLRequest() {
<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L56">        getGlobalMetrics().recordRequest();</span>
<span class="nc" id="L57">        getGraphQLMetrics().recordRequest();</span>
<span class="nc" id="L58">    }</span>
    
    /**
     * Records a successful REST API response.
     */
    public void recordRestSuccess(Duration responseTime) {
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L66">        getGlobalMetrics().recordSuccess(responseTime);</span>
<span class="nc" id="L67">        getRestMetrics().recordSuccess(responseTime);</span>
<span class="nc" id="L68">    }</span>
    
    /**
     * Records a successful GraphQL API response.
     */
    public void recordGraphQLSuccess(Duration responseTime) {
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L76">        getGlobalMetrics().recordSuccess(responseTime);</span>
<span class="nc" id="L77">        getGraphQLMetrics().recordSuccess(responseTime);</span>
<span class="nc" id="L78">    }</span>
    
    /**
     * Records a failed REST API response.
     */
    public void recordRestFailure(Duration responseTime, Throwable error) {
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L86">        getGlobalMetrics().recordFailure(responseTime, error);</span>
<span class="nc" id="L87">        getRestMetrics().recordFailure(responseTime, error);</span>
<span class="nc" id="L88">    }</span>
    
    /**
     * Records a failed GraphQL API response.
     */
    public void recordGraphQLFailure(Duration responseTime, Throwable error) {
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L96">        getGlobalMetrics().recordFailure(responseTime, error);</span>
<span class="nc" id="L97">        getGraphQLMetrics().recordFailure(responseTime, error);</span>
<span class="nc" id="L98">    }</span>
    
    /**
     * Records a retry attempt.
     */
    public void recordRetry(String apiType) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L106">        getGlobalMetrics().recordRetry();</span>
        
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (&quot;rest&quot;.equalsIgnoreCase(apiType)) {</span>
<span class="nc" id="L109">            getRestMetrics().recordRetry();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">        } else if (&quot;graphql&quot;.equalsIgnoreCase(apiType)) {</span>
<span class="nc" id="L111">            getGraphQLMetrics().recordRetry();</span>
        }
<span class="nc" id="L113">    }</span>
    
    /**
     * Records rate limiting.
     */
    public void recordRateLimit(String apiType, Duration waitTime) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (!monitoringEnabled) return;</span>
        
<span class="nc" id="L121">        getGlobalMetrics().recordRateLimit(waitTime);</span>
        
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (&quot;rest&quot;.equalsIgnoreCase(apiType)) {</span>
<span class="nc" id="L124">            getRestMetrics().recordRateLimit(waitTime);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        } else if (&quot;graphql&quot;.equalsIgnoreCase(apiType)) {</span>
<span class="nc" id="L126">            getGraphQLMetrics().recordRateLimit(waitTime);</span>
        }
<span class="nc" id="L128">    }</span>
    
    /**
     * Gets global API metrics.
     */
    public ApiMetrics getGlobalMetrics() {
<span class="nc" id="L134">        return metricsMap.get(GLOBAL_METRICS_KEY);</span>
    }
    
    /**
     * Gets REST API metrics.
     */
    public ApiMetrics getRestMetrics() {
<span class="nc" id="L141">        return metricsMap.get(REST_METRICS_KEY);</span>
    }
    
    /**
     * Gets GraphQL API metrics.
     */
    public ApiMetrics getGraphQLMetrics() {
<span class="nc" id="L148">        return metricsMap.get(GRAPHQL_METRICS_KEY);</span>
    }
    
    /**
     * Gets or creates custom metrics for a specific component.
     */
    public ApiMetrics getOrCreateMetrics(String name) {
<span class="nc" id="L155">        return metricsMap.computeIfAbsent(name, k -&gt; new ApiMetrics());</span>
    }
    
    /**
     * Gets metrics by name.
     */
    public ApiMetrics getMetrics(String name) {
<span class="nc" id="L162">        return metricsMap.get(name);</span>
    }
    
    /**
     * Gets all available metrics.
     */
    public Map&lt;String, ApiMetrics&gt; getAllMetrics() {
<span class="nc" id="L169">        return Map.copyOf(metricsMap);</span>
    }
    
    /**
     * Resets all metrics.
     */
    public void resetAllMetrics() {
<span class="nc" id="L176">        metricsMap.values().forEach(ApiMetrics::reset);</span>
<span class="nc" id="L177">        log.info(&quot;All metrics have been reset&quot;);</span>
<span class="nc" id="L178">    }</span>
    
    /**
     * Resets specific metrics.
     */
    public void resetMetrics(String name) {
<span class="nc" id="L184">        ApiMetrics metrics = metricsMap.get(name);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (metrics != null) {</span>
<span class="nc" id="L186">            metrics.reset();</span>
<span class="nc" id="L187">            log.info(&quot;Metrics '{}' have been reset&quot;, name);</span>
        }
<span class="nc" id="L189">    }</span>
    
    /**
     * Gets a comprehensive monitoring report.
     */
    public MonitoringReport getReport() {
<span class="nc" id="L195">        return MonitoringReport.builder()</span>
<span class="nc" id="L196">            .timestamp(Instant.now())</span>
<span class="nc" id="L197">            .globalSummary(getGlobalMetrics().getSummary())</span>
<span class="nc" id="L198">            .restSummary(getRestMetrics().getSummary())</span>
<span class="nc" id="L199">            .graphQLSummary(getGraphQLMetrics().getSummary())</span>
<span class="nc" id="L200">            .customMetrics(metricsMap.entrySet().stream()</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                .filter(entry -&gt; !isSystemMetrics(entry.getKey()))</span>
<span class="nc" id="L202">                .collect(java.util.stream.Collectors.toMap(</span>
                    Map.Entry::getKey,
<span class="nc" id="L204">                    entry -&gt; entry.getValue().getSummary()</span>
                )))
<span class="nc" id="L206">            .monitoringEnabled(monitoringEnabled)</span>
<span class="nc" id="L207">            .build();</span>
    }
    
    /**
     * Enables monitoring.
     */
    public void enableMonitoring() {
<span class="nc" id="L214">        monitoringEnabled = true;</span>
<span class="nc" id="L215">        log.info(&quot;Monitoring enabled&quot;);</span>
<span class="nc" id="L216">    }</span>
    
    /**
     * Disables monitoring.
     */
    public void disableMonitoring() {
<span class="nc" id="L222">        monitoringEnabled = false;</span>
<span class="nc" id="L223">        log.info(&quot;Monitoring disabled&quot;);</span>
<span class="nc" id="L224">    }</span>
    
    /**
     * Checks if monitoring is enabled.
     */
    public boolean isMonitoringEnabled() {
<span class="nc" id="L230">        return monitoringEnabled;</span>
    }
    
    /**
     * Logs a summary of current metrics.
     */
    public void logSummary() {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (!monitoringEnabled) {</span>
<span class="nc" id="L238">            log.info(&quot;Monitoring is disabled&quot;);</span>
<span class="nc" id="L239">            return;</span>
        }
        
<span class="nc" id="L242">        ApiMetrics.MetricsSummary global = getGlobalMetrics().getSummary();</span>
<span class="nc" id="L243">        ApiMetrics.MetricsSummary rest = getRestMetrics().getSummary();</span>
<span class="nc" id="L244">        ApiMetrics.MetricsSummary graphql = getGraphQLMetrics().getSummary();</span>
        
<span class="nc" id="L246">        log.info(&quot;=== Shopify API Metrics Summary ===&quot;);</span>
<span class="nc" id="L247">        log.info(&quot;Global: {} total requests, {:.1f}% success rate, {:.1f}ms avg response time, {:.2f} req/sec&quot;,</span>
<span class="nc" id="L248">            global.getTotalRequests(), global.getSuccessRate(), </span>
<span class="nc" id="L249">            global.getAverageResponseTimeMs(), global.getRequestsPerSecond());</span>
        
<span class="nc" id="L251">        log.info(&quot;REST: {} requests, {:.1f}% success, {:.1f}ms avg response&quot;,</span>
<span class="nc" id="L252">            rest.getTotalRequests(), rest.getSuccessRate(), rest.getAverageResponseTimeMs());</span>
        
<span class="nc" id="L254">        log.info(&quot;GraphQL: {} requests, {:.1f}% success, {:.1f}ms avg response&quot;,</span>
<span class="nc" id="L255">            graphql.getTotalRequests(), graphql.getSuccessRate(), graphql.getAverageResponseTimeMs());</span>
        
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (global.getRetryAttempts() &gt; 0) {</span>
<span class="nc" id="L258">            log.info(&quot;Retries: {} attempts, Rate limits: {} requests&quot;,</span>
<span class="nc" id="L259">                global.getRetryAttempts(), global.getRateLimitedRequests());</span>
        }
        
<span class="nc" id="L262">        log.info(&quot;Uptime: {}&quot;, formatDuration(global.getUptime()));</span>
<span class="nc" id="L263">    }</span>
    
    /**
     * Starts periodic reporting of metrics.
     */
    private void startPeriodicReporting() {
<span class="nc" id="L269">        scheduler.scheduleAtFixedRate(() -&gt; {</span>
            try {
<span class="nc bnc" id="L271" title="All 2 branches missed.">                if (monitoringEnabled) {</span>
<span class="nc" id="L272">                    logSummary();</span>
                }
<span class="nc" id="L274">            } catch (Exception e) {</span>
<span class="nc" id="L275">                log.error(&quot;Error during periodic metrics reporting&quot;, e);</span>
<span class="nc" id="L276">            }</span>
<span class="nc" id="L277">        }, 5, 60, TimeUnit.MINUTES); // Report every hour, start after 5 minutes</span>
<span class="nc" id="L278">    }</span>
    
    /**
     * Checks if a metrics key is a system metrics.
     */
    private boolean isSystemMetrics(String key) {
<span class="nc bnc" id="L284" title="All 2 branches missed.">        return GLOBAL_METRICS_KEY.equals(key) || </span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">               REST_METRICS_KEY.equals(key) || </span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">               GRAPHQL_METRICS_KEY.equals(key);</span>
    }
    
    /**
     * Formats a duration for display.
     */
    private String formatDuration(Duration duration) {
<span class="nc" id="L293">        long hours = duration.toHours();</span>
<span class="nc" id="L294">        long minutes = duration.toMinutesPart();</span>
<span class="nc" id="L295">        long seconds = duration.toSecondsPart();</span>
        
<span class="nc bnc" id="L297" title="All 2 branches missed.">        if (hours &gt; 0) {</span>
<span class="nc" id="L298">            return String.format(&quot;%dh %dm %ds&quot;, hours, minutes, seconds);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">        } else if (minutes &gt; 0) {</span>
<span class="nc" id="L300">            return String.format(&quot;%dm %ds&quot;, minutes, seconds);</span>
        } else {
<span class="nc" id="L302">            return String.format(&quot;%ds&quot;, seconds);</span>
        }
    }
    
    /**
     * Shuts down the monitoring service.
     */
    public void shutdown() {
<span class="nc" id="L310">        scheduler.shutdown();</span>
        try {
<span class="nc bnc" id="L312" title="All 2 branches missed.">            if (!scheduler.awaitTermination(5, TimeUnit.SECONDS)) {</span>
<span class="nc" id="L313">                scheduler.shutdownNow();</span>
            }
<span class="nc" id="L315">        } catch (InterruptedException e) {</span>
<span class="nc" id="L316">            scheduler.shutdownNow();</span>
<span class="nc" id="L317">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L318">        }</span>
<span class="nc" id="L319">        log.info(&quot;Monitoring service shut down&quot;);</span>
<span class="nc" id="L320">    }</span>
    
    /**
     * Comprehensive monitoring report.
     */
<span class="nc bnc" id="L325" title="All 50 branches missed.">    @lombok.Data</span>
<span class="nc" id="L326">    @lombok.Builder</span>
    public static class MonitoringReport {
<span class="nc" id="L328">        private final Instant timestamp;</span>
<span class="nc" id="L329">        private final ApiMetrics.MetricsSummary globalSummary;</span>
<span class="nc" id="L330">        private final ApiMetrics.MetricsSummary restSummary;</span>
<span class="nc" id="L331">        private final ApiMetrics.MetricsSummary graphQLSummary;</span>
<span class="nc" id="L332">        private final Map&lt;String, ApiMetrics.MetricsSummary&gt; customMetrics;</span>
<span class="nc" id="L333">        private final boolean monitoringEnabled;</span>
        
        public boolean hasErrors() {
<span class="nc bnc" id="L336" title="All 2 branches missed.">            return globalSummary.getFailedRequests() &gt; 0;</span>
        }
        
        public boolean hasHighFailureRate() {
<span class="nc bnc" id="L340" title="All 2 branches missed.">            return globalSummary.getFailureRate() &gt; 10.0; // More than 10% failure rate</span>
        }
        
        public boolean hasSlowResponses() {
<span class="nc bnc" id="L344" title="All 2 branches missed.">            return globalSummary.getAverageResponseTimeMs() &gt; 2000; // More than 2 seconds average</span>
        }
        
        public boolean hasRateLimiting() {
<span class="nc bnc" id="L348" title="All 2 branches missed.">            return globalSummary.getRateLimitedRequests() &gt; 0;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>