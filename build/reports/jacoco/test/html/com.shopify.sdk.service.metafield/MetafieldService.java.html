<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetafieldService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.service.metafield</a> &gt; <span class="el_source">MetafieldService.java</span></div><h1>MetafieldService.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.service.metafield;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.shopify.sdk.client.ShopifyGraphQLClient;
import com.shopify.sdk.client.ShopifyRestClient;
import com.shopify.sdk.model.metafield.Metafield;
import com.shopify.sdk.model.metafield.MetafieldType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Map;

<span class="nc" id="L16">@Slf4j</span>
@Service
<span class="nc" id="L18">@RequiredArgsConstructor</span>
public class MetafieldService {
    
    private final ShopifyGraphQLClient graphQLClient;
    private final ShopifyRestClient restClient;
    private final ObjectMapper objectMapper;
    
    private static final String METAFIELDS_QUERY = &quot;&quot;&quot;
        query getMetafields($first: Int, $after: String, $namespace: String, $owner: ID!) {
            node(id: $owner) {
                ... on Product {
                    metafields(first: $first, after: $after, namespace: $namespace) {
                        edges {
                            cursor
                            node {
                                id
                                namespace
                                key
                                value
                                type
                                description
                                createdAt
                                updatedAt
                            }
                        }
                        pageInfo {
                            hasNextPage
                            hasPreviousPage
                            startCursor
                            endCursor
                        }
                    }
                }
                ... on Customer {
                    metafields(first: $first, after: $after, namespace: $namespace) {
                        edges {
                            cursor
                            node {
                                id
                                namespace
                                key
                                value
                                type
                                description
                                createdAt
                                updatedAt
                            }
                        }
                        pageInfo {
                            hasNextPage
                            hasPreviousPage
                            startCursor
                            endCursor
                        }
                    }
                }
                ... on Order {
                    metafields(first: $first, after: $after, namespace: $namespace) {
                        edges {
                            cursor
                            node {
                                id
                                namespace
                                key
                                value
                                type
                                description
                                createdAt
                                updatedAt
                            }
                        }
                        pageInfo {
                            hasNextPage
                            hasPreviousPage
                            startCursor
                            endCursor
                        }
                    }
                }
                ... on Collection {
                    metafields(first: $first, after: $after, namespace: $namespace) {
                        edges {
                            cursor
                            node {
                                id
                                namespace
                                key
                                value
                                type
                                description
                                createdAt
                                updatedAt
                            }
                        }
                        pageInfo {
                            hasNextPage
                            hasPreviousPage
                            startCursor
                            endCursor
                        }
                    }
                }
            }
        }
        &quot;&quot;&quot;;
    
    private static final String CREATE_METAFIELD_MUTATION = &quot;&quot;&quot;
        mutation metafieldSet($metafields: [MetafieldsSetInput!]!) {
            metafieldsSet(metafields: $metafields) {
                metafields {
                    id
                    namespace
                    key
                    value
                    type
                    description
                    createdAt
                    updatedAt
                }
                userErrors {
                    field
                    message
                }
            }
        }
        &quot;&quot;&quot;;
    
    private static final String DELETE_METAFIELD_MUTATION = &quot;&quot;&quot;
        mutation metafieldDelete($input: MetafieldDeleteInput!) {
            metafieldDelete(input: $input) {
                deletedId
                userErrors {
                    field
                    message
                }
            }
        }
        &quot;&quot;&quot;;
    
    public Mono&lt;List&lt;Metafield&gt;&gt; getMetafields(String shop, String accessToken, String ownerId, String namespace, Integer first, String after) {
<span class="nc" id="L158">        Map&lt;String, Object&gt; variables = Map.of(</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            &quot;first&quot;, first != null ? first : 50,</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            &quot;after&quot;, after != null ? after : &quot;&quot;,</span>
            &quot;namespace&quot;, namespace,
            &quot;owner&quot;, ownerId
        );
        
<span class="nc" id="L165">        return graphQLClient.query(shop, accessToken, METAFIELDS_QUERY, variables)</span>
<span class="nc" id="L166">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L168">                    var edges = response.getData().get(&quot;node&quot;).get(&quot;metafields&quot;).get(&quot;edges&quot;);</span>
<span class="nc" id="L169">                    return objectMapper.convertValue(edges,</span>
<span class="nc" id="L170">                        objectMapper.getTypeFactory().constructCollectionType(List.class, Metafield.class));</span>
<span class="nc" id="L171">                } catch (Exception e) {</span>
<span class="nc" id="L172">                    log.error(&quot;Failed to parse metafields response&quot;, e);</span>
<span class="nc" id="L173">                    throw new RuntimeException(&quot;Failed to parse metafields response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;List&lt;Metafield&gt;&gt; createMetafields(String shop, String accessToken, List&lt;MetafieldInput&gt; metafields) {
<span class="nc" id="L179">        Map&lt;String, Object&gt; variables = Map.of(&quot;metafields&quot;, metafields);</span>
        
<span class="nc" id="L181">        return graphQLClient.query(shop, accessToken, CREATE_METAFIELD_MUTATION, variables)</span>
<span class="nc" id="L182">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L184">                    var data = response.getData().get(&quot;metafieldsSet&quot;).get(&quot;metafields&quot;);</span>
<span class="nc" id="L185">                    return objectMapper.convertValue(data,</span>
<span class="nc" id="L186">                        objectMapper.getTypeFactory().constructCollectionType(List.class, Metafield.class));</span>
<span class="nc" id="L187">                } catch (Exception e) {</span>
<span class="nc" id="L188">                    log.error(&quot;Failed to parse create metafields response&quot;, e);</span>
<span class="nc" id="L189">                    throw new RuntimeException(&quot;Failed to parse create metafields response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;String&gt; deleteMetafield(String shop, String accessToken, String metafieldId) {
<span class="nc" id="L195">        Map&lt;String, Object&gt; input = Map.of(&quot;id&quot;, metafieldId);</span>
<span class="nc" id="L196">        Map&lt;String, Object&gt; variables = Map.of(&quot;input&quot;, input);</span>
        
<span class="nc" id="L198">        return graphQLClient.query(shop, accessToken, DELETE_METAFIELD_MUTATION, variables)</span>
<span class="nc" id="L199">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L201">                    return response.getData().get(&quot;metafieldDelete&quot;).get(&quot;deletedId&quot;).asText();</span>
<span class="nc" id="L202">                } catch (Exception e) {</span>
<span class="nc" id="L203">                    log.error(&quot;Failed to parse delete metafield response&quot;, e);</span>
<span class="nc" id="L204">                    throw new RuntimeException(&quot;Failed to parse delete metafield response&quot;, e);</span>
                }
            });
    }
    
    // REST API methods for legacy support
    
    public Mono&lt;List&lt;Metafield&gt;&gt; getMetafieldsRest(String shop, String accessToken, String resourceType, String resourceId) {
<span class="nc" id="L212">        String endpoint = &quot;/admin/api/2023-10/&quot; + resourceType + &quot;/&quot; + resourceId + &quot;/metafields.json&quot;;</span>
        
<span class="nc" id="L214">        return restClient.get(shop, accessToken, endpoint)</span>
<span class="nc" id="L215">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L217">                    var data = response.get(&quot;metafields&quot;);</span>
<span class="nc" id="L218">                    return objectMapper.convertValue(data,</span>
<span class="nc" id="L219">                        objectMapper.getTypeFactory().constructCollectionType(List.class, Metafield.class));</span>
<span class="nc" id="L220">                } catch (Exception e) {</span>
<span class="nc" id="L221">                    log.error(&quot;Failed to parse metafields REST response&quot;, e);</span>
<span class="nc" id="L222">                    throw new RuntimeException(&quot;Failed to parse metafields REST response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;Metafield&gt; getMetafieldRest(String shop, String accessToken, String metafieldId) {
<span class="nc" id="L228">        String endpoint = &quot;/admin/api/2023-10/metafields/&quot; + metafieldId + &quot;.json&quot;;</span>
        
<span class="nc" id="L230">        return restClient.get(shop, accessToken, endpoint)</span>
<span class="nc" id="L231">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L233">                    var data = response.get(&quot;metafield&quot;);</span>
<span class="nc" id="L234">                    return objectMapper.convertValue(data, Metafield.class);</span>
<span class="nc" id="L235">                } catch (Exception e) {</span>
<span class="nc" id="L236">                    log.error(&quot;Failed to parse metafield REST response&quot;, e);</span>
<span class="nc" id="L237">                    throw new RuntimeException(&quot;Failed to parse metafield REST response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;Metafield&gt; createMetafieldRest(String shop, String accessToken, String resourceType, String resourceId, MetafieldCreateRequest metafield) {
<span class="nc" id="L243">        String endpoint = &quot;/admin/api/2023-10/&quot; + resourceType + &quot;/&quot; + resourceId + &quot;/metafields.json&quot;;</span>
        
<span class="nc" id="L245">        return restClient.post(shop, accessToken, endpoint, Map.of(&quot;metafield&quot;, metafield))</span>
<span class="nc" id="L246">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L248">                    var data = response.get(&quot;metafield&quot;);</span>
<span class="nc" id="L249">                    return objectMapper.convertValue(data, Metafield.class);</span>
<span class="nc" id="L250">                } catch (Exception e) {</span>
<span class="nc" id="L251">                    log.error(&quot;Failed to parse create metafield REST response&quot;, e);</span>
<span class="nc" id="L252">                    throw new RuntimeException(&quot;Failed to parse create metafield REST response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;Metafield&gt; updateMetafieldRest(String shop, String accessToken, String metafieldId, MetafieldUpdateRequest metafield) {
<span class="nc" id="L258">        String endpoint = &quot;/admin/api/2023-10/metafields/&quot; + metafieldId + &quot;.json&quot;;</span>
        
<span class="nc" id="L260">        return restClient.post(shop, accessToken, endpoint, Map.of(&quot;metafield&quot;, metafield))</span>
<span class="nc" id="L261">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L263">                    var data = response.get(&quot;metafield&quot;);</span>
<span class="nc" id="L264">                    return objectMapper.convertValue(data, Metafield.class);</span>
<span class="nc" id="L265">                } catch (Exception e) {</span>
<span class="nc" id="L266">                    log.error(&quot;Failed to parse update metafield REST response&quot;, e);</span>
<span class="nc" id="L267">                    throw new RuntimeException(&quot;Failed to parse update metafield REST response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;Void&gt; deleteMetafieldRest(String shop, String accessToken, String metafieldId) {
<span class="nc" id="L273">        String endpoint = &quot;/admin/api/2023-10/metafields/&quot; + metafieldId + &quot;.json&quot;;</span>
        
<span class="nc" id="L275">        return restClient.delete(shop, accessToken, endpoint)</span>
<span class="nc" id="L276">            .then();</span>
    }
    
    // Shop-level metafields
    
    public Mono&lt;List&lt;Metafield&gt;&gt; getShopMetafields(String shop, String accessToken, String namespace) {
<span class="nc" id="L282">        String endpoint = &quot;/admin/api/2023-10/metafields.json&quot;;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        Map&lt;String, Object&gt; params = namespace != null ? Map.of(&quot;namespace&quot;, namespace) : Map.of();</span>
        
<span class="nc" id="L285">        return restClient.get(shop, accessToken, endpoint, params)</span>
<span class="nc" id="L286">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L288">                    var data = response.get(&quot;metafields&quot;);</span>
<span class="nc" id="L289">                    return objectMapper.convertValue(data,</span>
<span class="nc" id="L290">                        objectMapper.getTypeFactory().constructCollectionType(List.class, Metafield.class));</span>
<span class="nc" id="L291">                } catch (Exception e) {</span>
<span class="nc" id="L292">                    log.error(&quot;Failed to parse shop metafields response&quot;, e);</span>
<span class="nc" id="L293">                    throw new RuntimeException(&quot;Failed to parse shop metafields response&quot;, e);</span>
                }
            });
    }
    
    public Mono&lt;Metafield&gt; createShopMetafield(String shop, String accessToken, MetafieldCreateRequest metafield) {
<span class="nc" id="L299">        String endpoint = &quot;/admin/api/2023-10/metafields.json&quot;;</span>
        
<span class="nc" id="L301">        return restClient.post(shop, accessToken, endpoint, Map.of(&quot;metafield&quot;, metafield))</span>
<span class="nc" id="L302">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L304">                    var data = response.get(&quot;metafield&quot;);</span>
<span class="nc" id="L305">                    return objectMapper.convertValue(data, Metafield.class);</span>
<span class="nc" id="L306">                } catch (Exception e) {</span>
<span class="nc" id="L307">                    log.error(&quot;Failed to parse create shop metafield response&quot;, e);</span>
<span class="nc" id="L308">                    throw new RuntimeException(&quot;Failed to parse create shop metafield response&quot;, e);</span>
                }
            });
    }
    
<span class="nc bnc" id="L313" title="All 54 branches missed.">    @lombok.Data</span>
<span class="nc" id="L314">    @lombok.NoArgsConstructor</span>
<span class="nc" id="L315">    @lombok.AllArgsConstructor</span>
<span class="nc" id="L316">    @lombok.Builder</span>
    public static class MetafieldInput {
<span class="nc" id="L318">        private String ownerId;</span>
<span class="nc" id="L319">        private String namespace;</span>
<span class="nc" id="L320">        private String key;</span>
<span class="nc" id="L321">        private String value;</span>
<span class="nc" id="L322">        private MetafieldType type;</span>
<span class="nc" id="L323">        private String description;</span>
    }
    
<span class="nc bnc" id="L326" title="All 46 branches missed.">    @lombok.Data</span>
<span class="nc" id="L327">    @lombok.NoArgsConstructor</span>
<span class="nc" id="L328">    @lombok.AllArgsConstructor</span>
<span class="nc" id="L329">    @lombok.Builder</span>
    public static class MetafieldCreateRequest {
<span class="nc" id="L331">        private String namespace;</span>
<span class="nc" id="L332">        private String key;</span>
<span class="nc" id="L333">        private String value;</span>
<span class="nc" id="L334">        private String type;</span>
<span class="nc" id="L335">        private String description;</span>
    }
    
<span class="nc bnc" id="L338" title="All 46 branches missed.">    @lombok.Data</span>
<span class="nc" id="L339">    @lombok.NoArgsConstructor</span>
<span class="nc" id="L340">    @lombok.AllArgsConstructor</span>
<span class="nc" id="L341">    @lombok.Builder</span>
    public static class MetafieldUpdateRequest {
<span class="nc" id="L343">        private String namespace;</span>
<span class="nc" id="L344">        private String key;</span>
<span class="nc" id="L345">        private String value;</span>
<span class="nc" id="L346">        private String type;</span>
<span class="nc" id="L347">        private String description;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>