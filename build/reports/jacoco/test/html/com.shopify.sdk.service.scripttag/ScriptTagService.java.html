<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScriptTagService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.service.scripttag</a> &gt; <span class="el_source">ScriptTagService.java</span></div><h1>ScriptTagService.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.service.scripttag;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.shopify.sdk.client.ShopifyRestClient;
import com.shopify.sdk.model.scripttag.ScriptTag;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

import java.util.List;
import java.util.Map;

<span class="nc" id="L14">@Slf4j</span>
@Service
<span class="nc" id="L16">@RequiredArgsConstructor</span>
public class ScriptTagService {
    
    private final ShopifyRestClient restClient;
    private final ObjectMapper objectMapper;
    
    /**
     * Gets all script tags for a store.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; getScriptTags(String shop, String accessToken) {
<span class="nc" id="L26">        String endpoint = &quot;/admin/api/2023-10/script_tags.json&quot;;</span>
        
<span class="nc" id="L28">        return restClient.get(shop, accessToken, endpoint)</span>
<span class="nc" id="L29">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L31">                    var data = response.get(&quot;script_tags&quot;);</span>
<span class="nc" id="L32">                    return objectMapper.convertValue(data,</span>
<span class="nc" id="L33">                        objectMapper.getTypeFactory().constructCollectionType(List.class, ScriptTag.class));</span>
<span class="nc" id="L34">                } catch (Exception e) {</span>
<span class="nc" id="L35">                    log.error(&quot;Failed to parse script tags response&quot;, e);</span>
<span class="nc" id="L36">                    throw new RuntimeException(&quot;Failed to parse script tags response&quot;, e);</span>
                }
            });
    }
    
    /**
     * Gets script tags with filtering options.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; getScriptTags(String shop, String accessToken, String src, Integer limit, 
                                             Integer sinceId, String createdAtMin, String createdAtMax,
                                             String updatedAtMin, String updatedAtMax, String fields) {
<span class="nc" id="L47">        String endpoint = &quot;/admin/api/2023-10/script_tags.json&quot;;</span>
        
<span class="nc" id="L49">        Map&lt;String, Object&gt; params = Map.of(</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">            &quot;src&quot;, src != null ? src : &quot;&quot;,</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            &quot;limit&quot;, limit != null ? limit : 50,</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            &quot;since_id&quot;, sinceId != null ? sinceId : 0,</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">            &quot;created_at_min&quot;, createdAtMin != null ? createdAtMin : &quot;&quot;,</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            &quot;created_at_max&quot;, createdAtMax != null ? createdAtMax : &quot;&quot;,</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">            &quot;updated_at_min&quot;, updatedAtMin != null ? updatedAtMin : &quot;&quot;,</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">            &quot;updated_at_max&quot;, updatedAtMax != null ? updatedAtMax : &quot;&quot;,</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            &quot;fields&quot;, fields != null ? fields : &quot;&quot;</span>
        );
        
        // Remove empty parameters
<span class="nc" id="L61">        params.entrySet().removeIf(entry -&gt; {</span>
<span class="nc" id="L62">            Object value = entry.getValue();</span>
<span class="nc bnc" id="L63" title="All 8 branches missed.">            return value == null || (value instanceof String &amp;&amp; ((String) value).isEmpty()) ||</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                   (value instanceof Integer &amp;&amp; ((Integer) value) == 0);</span>
        });
        
<span class="nc" id="L67">        return restClient.get(shop, accessToken, endpoint, params)</span>
<span class="nc" id="L68">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L70">                    var data = response.get(&quot;script_tags&quot;);</span>
<span class="nc" id="L71">                    return objectMapper.convertValue(data,</span>
<span class="nc" id="L72">                        objectMapper.getTypeFactory().constructCollectionType(List.class, ScriptTag.class));</span>
<span class="nc" id="L73">                } catch (Exception e) {</span>
<span class="nc" id="L74">                    log.error(&quot;Failed to parse script tags response&quot;, e);</span>
<span class="nc" id="L75">                    throw new RuntimeException(&quot;Failed to parse script tags response&quot;, e);</span>
                }
            });
    }
    
    /**
     * Gets a specific script tag by ID.
     */
    public Mono&lt;ScriptTag&gt; getScriptTag(String shop, String accessToken, String scriptTagId) {
<span class="nc" id="L84">        String endpoint = &quot;/admin/api/2023-10/script_tags/&quot; + scriptTagId + &quot;.json&quot;;</span>
        
<span class="nc" id="L86">        return restClient.get(shop, accessToken, endpoint)</span>
<span class="nc" id="L87">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L89">                    var data = response.get(&quot;script_tag&quot;);</span>
<span class="nc" id="L90">                    return objectMapper.convertValue(data, ScriptTag.class);</span>
<span class="nc" id="L91">                } catch (Exception e) {</span>
<span class="nc" id="L92">                    log.error(&quot;Failed to parse script tag response&quot;, e);</span>
<span class="nc" id="L93">                    throw new RuntimeException(&quot;Failed to parse script tag response&quot;, e);</span>
                }
            });
    }
    
    /**
     * Creates a new script tag.
     */
    public Mono&lt;ScriptTag&gt; createScriptTag(String shop, String accessToken, ScriptTagCreateRequest request) {
<span class="nc" id="L102">        String endpoint = &quot;/admin/api/2023-10/script_tags.json&quot;;</span>
        
<span class="nc" id="L104">        return restClient.post(shop, accessToken, endpoint, Map.of(&quot;script_tag&quot;, request))</span>
<span class="nc" id="L105">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L107">                    var data = response.get(&quot;script_tag&quot;);</span>
<span class="nc" id="L108">                    return objectMapper.convertValue(data, ScriptTag.class);</span>
<span class="nc" id="L109">                } catch (Exception e) {</span>
<span class="nc" id="L110">                    log.error(&quot;Failed to parse create script tag response&quot;, e);</span>
<span class="nc" id="L111">                    throw new RuntimeException(&quot;Failed to parse create script tag response&quot;, e);</span>
                }
            });
    }
    
    /**
     * Updates an existing script tag.
     */
    public Mono&lt;ScriptTag&gt; updateScriptTag(String shop, String accessToken, String scriptTagId, ScriptTagUpdateRequest request) {
<span class="nc" id="L120">        String endpoint = &quot;/admin/api/2023-10/script_tags/&quot; + scriptTagId + &quot;.json&quot;;</span>
        
<span class="nc" id="L122">        return restClient.put(shop, accessToken, endpoint, Map.of(&quot;script_tag&quot;, request))</span>
<span class="nc" id="L123">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L125">                    var data = response.get(&quot;script_tag&quot;);</span>
<span class="nc" id="L126">                    return objectMapper.convertValue(data, ScriptTag.class);</span>
<span class="nc" id="L127">                } catch (Exception e) {</span>
<span class="nc" id="L128">                    log.error(&quot;Failed to parse update script tag response&quot;, e);</span>
<span class="nc" id="L129">                    throw new RuntimeException(&quot;Failed to parse update script tag response&quot;, e);</span>
                }
            });
    }
    
    /**
     * Deletes a script tag.
     */
    public Mono&lt;Void&gt; deleteScriptTag(String shop, String accessToken, String scriptTagId) {
<span class="nc" id="L138">        String endpoint = &quot;/admin/api/2023-10/script_tags/&quot; + scriptTagId + &quot;.json&quot;;</span>
        
<span class="nc" id="L140">        return restClient.delete(shop, accessToken, endpoint)</span>
<span class="nc" id="L141">            .then();</span>
    }
    
    /**
     * Gets the count of script tags.
     */
    public Mono&lt;Integer&gt; getScriptTagCount(String shop, String accessToken) {
<span class="nc" id="L148">        String endpoint = &quot;/admin/api/2023-10/script_tags/count.json&quot;;</span>
        
<span class="nc" id="L150">        return restClient.get(shop, accessToken, endpoint)</span>
<span class="nc" id="L151">            .map(response -&gt; {</span>
                try {
<span class="nc" id="L153">                    return response.get(&quot;count&quot;).asInt();</span>
<span class="nc" id="L154">                } catch (Exception e) {</span>
<span class="nc" id="L155">                    log.error(&quot;Failed to parse script tag count response&quot;, e);</span>
<span class="nc" id="L156">                    throw new RuntimeException(&quot;Failed to parse script tag count response&quot;, e);</span>
                }
            });
    }
    
    // Convenience methods
    
    /**
     * Gets script tags that load on page load.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; getOnLoadScriptTags(String shop, String accessToken) {
<span class="nc" id="L167">        return getScriptTags(shop, accessToken)</span>
<span class="nc" id="L168">            .map(scriptTags -&gt; scriptTags.stream()</span>
<span class="nc" id="L169">                .filter(ScriptTag::isOnLoad)</span>
<span class="nc" id="L170">                .toList());</span>
    }
    
    /**
     * Gets script tags that load when DOM is ready.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; getDomReadyScriptTags(String shop, String accessToken) {
<span class="nc" id="L177">        return getScriptTags(shop, accessToken)</span>
<span class="nc" id="L178">            .map(scriptTags -&gt; scriptTags.stream()</span>
<span class="nc" id="L179">                .filter(ScriptTag::isDomReady)</span>
<span class="nc" id="L180">                .toList());</span>
    }
    
    /**
     * Gets script tags for online store.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; getOnlineStoreScriptTags(String shop, String accessToken) {
<span class="nc" id="L187">        return getScriptTags(shop, accessToken)</span>
<span class="nc" id="L188">            .map(scriptTags -&gt; scriptTags.stream()</span>
<span class="nc" id="L189">                .filter(ScriptTag::isOnlineStore)</span>
<span class="nc" id="L190">                .toList());</span>
    }
    
    /**
     * Gets script tags for order status page.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; getOrderStatusScriptTags(String shop, String accessToken) {
<span class="nc" id="L197">        return getScriptTags(shop, accessToken)</span>
<span class="nc" id="L198">            .map(scriptTags -&gt; scriptTags.stream()</span>
<span class="nc" id="L199">                .filter(ScriptTag::isOrderStatus)</span>
<span class="nc" id="L200">                .toList());</span>
    }
    
    /**
     * Finds script tags by source URL.
     */
    public Mono&lt;List&lt;ScriptTag&gt;&gt; findScriptTagsBySrc(String shop, String accessToken, String srcPattern) {
<span class="nc" id="L207">        return getScriptTags(shop, accessToken)</span>
<span class="nc" id="L208">            .map(scriptTags -&gt; scriptTags.stream()</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                .filter(scriptTag -&gt; scriptTag.getSrc() != null &amp;&amp; </span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">                                   scriptTag.getSrc().contains(srcPattern))</span>
<span class="nc" id="L211">                .toList());</span>
    }
    
    /**
     * Creates a script tag that loads on page load.
     */
    public Mono&lt;ScriptTag&gt; createOnLoadScriptTag(String shop, String accessToken, String src, String displayScope, Boolean cache) {
<span class="nc" id="L218">        ScriptTagCreateRequest request = ScriptTagCreateRequest.builder()</span>
<span class="nc" id="L219">            .src(src)</span>
<span class="nc" id="L220">            .event(ScriptTag.EVENT_ONLOAD)</span>
<span class="nc" id="L221">            .displayScope(displayScope)</span>
<span class="nc" id="L222">            .cache(cache)</span>
<span class="nc" id="L223">            .build();</span>
        
<span class="nc" id="L225">        return createScriptTag(shop, accessToken, request);</span>
    }
    
    /**
     * Creates a script tag that loads when DOM is ready.
     */
    public Mono&lt;ScriptTag&gt; createDomReadyScriptTag(String shop, String accessToken, String src, String displayScope, Boolean cache) {
<span class="nc" id="L232">        ScriptTagCreateRequest request = ScriptTagCreateRequest.builder()</span>
<span class="nc" id="L233">            .src(src)</span>
<span class="nc" id="L234">            .event(ScriptTag.EVENT_DOM_READY)</span>
<span class="nc" id="L235">            .displayScope(displayScope)</span>
<span class="nc" id="L236">            .cache(cache)</span>
<span class="nc" id="L237">            .build();</span>
        
<span class="nc" id="L239">        return createScriptTag(shop, accessToken, request);</span>
    }
    
<span class="nc bnc" id="L242" title="All 38 branches missed.">    @lombok.Data</span>
<span class="nc" id="L243">    @lombok.NoArgsConstructor</span>
<span class="nc" id="L244">    @lombok.AllArgsConstructor</span>
<span class="nc" id="L245">    @lombok.Builder</span>
    public static class ScriptTagCreateRequest {
<span class="nc" id="L247">        private String src;</span>
<span class="nc" id="L248">        private String event;</span>
<span class="nc" id="L249">        private String displayScope;</span>
<span class="nc" id="L250">        private Boolean cache;</span>
    }
    
<span class="nc bnc" id="L253" title="All 38 branches missed.">    @lombok.Data</span>
<span class="nc" id="L254">    @lombok.NoArgsConstructor</span>
<span class="nc" id="L255">    @lombok.AllArgsConstructor</span>
<span class="nc" id="L256">    @lombok.Builder</span>
    public static class ScriptTagUpdateRequest {
<span class="nc" id="L258">        private String src;</span>
<span class="nc" id="L259">        private String event;</span>
<span class="nc" id="L260">        private String displayScope;</span>
<span class="nc" id="L261">        private Boolean cache;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>