<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtTokenValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.auth</a> &gt; <span class="el_source">JwtTokenValidator.java</span></div><h1>JwtTokenValidator.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.auth;

import com.shopify.sdk.config.ShopifyAuthContext;
import com.shopify.sdk.exception.ShopifyApiException;
import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.time.Instant;
import java.util.Date;
import java.util.Map;

/**
 * JWT token validator for Shopify applications.
 */
<span class="fc" id="L20">@Slf4j</span>
@Component
<span class="nc" id="L22">@RequiredArgsConstructor</span>
public class JwtTokenValidator {
    
    private final ShopifyAuthContext context;
    
    /**
     * Validates and parses a JWT token from Shopify.
     *
     * @param token the JWT token to validate
     * @return the parsed JWT claims
     * @throws ShopifyApiException if the token is invalid
     */
    public JwtClaims validateToken(String token) {
<span class="nc bnc" id="L35" title="All 4 branches missed.">        if (token == null || token.trim().isEmpty()) {</span>
<span class="nc" id="L36">            throw new ShopifyApiException(&quot;JWT token cannot be null or empty&quot;);</span>
        }
        
        try {
<span class="nc" id="L40">            SecretKey key = Keys.hmacShaKeyFor(context.getApiSecret().getBytes(StandardCharsets.UTF_8));</span>
            
<span class="nc" id="L42">            Jws&lt;Claims&gt; jws = Jwts.parser()</span>
<span class="nc" id="L43">                .verifyWith(key)</span>
<span class="nc" id="L44">                .build()</span>
<span class="nc" id="L45">                .parseSignedClaims(token);</span>
                
<span class="nc" id="L47">            Claims claims = jws.getBody();</span>
            
            // Validate required claims
<span class="nc" id="L50">            validateRequiredClaims(claims);</span>
            
<span class="nc" id="L52">            return JwtClaims.fromJwtClaims(claims);</span>
            
<span class="nc" id="L54">        } catch (ExpiredJwtException e) {</span>
<span class="nc" id="L55">            log.warn(&quot;JWT token has expired: {}&quot;, e.getMessage());</span>
<span class="nc" id="L56">            throw new ShopifyApiException(&quot;JWT token has expired&quot;, e);</span>
<span class="nc" id="L57">        } catch (UnsupportedJwtException e) {</span>
<span class="nc" id="L58">            log.warn(&quot;Unsupported JWT token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L59">            throw new ShopifyApiException(&quot;Unsupported JWT token&quot;, e);</span>
<span class="nc" id="L60">        } catch (MalformedJwtException e) {</span>
<span class="nc" id="L61">            log.warn(&quot;Malformed JWT token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L62">            throw new ShopifyApiException(&quot;Malformed JWT token&quot;, e);</span>
<span class="nc" id="L63">        } catch (SignatureException e) {</span>
<span class="nc" id="L64">            log.warn(&quot;Invalid JWT signature: {}&quot;, e.getMessage());</span>
<span class="nc" id="L65">            throw new ShopifyApiException(&quot;Invalid JWT signature&quot;, e);</span>
<span class="nc" id="L66">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L67">            log.warn(&quot;Invalid JWT token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L68">            throw new ShopifyApiException(&quot;Invalid JWT token&quot;, e);</span>
        }
    }
    
    /**
     * Validates a JWT token without throwing exceptions.
     *
     * @param token the JWT token to validate
     * @return true if valid, false otherwise
     */
    public boolean isTokenValid(String token) {
        try {
<span class="nc" id="L80">            validateToken(token);</span>
<span class="nc" id="L81">            return true;</span>
<span class="nc" id="L82">        } catch (Exception e) {</span>
<span class="nc" id="L83">            log.debug(&quot;Token validation failed: {}&quot;, e.getMessage());</span>
<span class="nc" id="L84">            return false;</span>
        }
    }
    
    /**
     * Extracts the shop domain from a JWT token without full validation.
     *
     * @param token the JWT token
     * @return the shop domain or null if not found
     */
    public String extractShopDomain(String token) {
        try {
            // Parse without verification to extract shop domain
<span class="nc" id="L97">            int firstDot = token.indexOf('.');</span>
<span class="nc" id="L98">            int secondDot = token.indexOf('.', firstDot + 1);</span>
            
<span class="nc bnc" id="L100" title="All 4 branches missed.">            if (firstDot == -1 || secondDot == -1) {</span>
<span class="nc" id="L101">                return null;</span>
            }
            
<span class="nc" id="L104">            String payload = token.substring(firstDot + 1, secondDot);</span>
<span class="nc" id="L105">            String decodedPayload = new String(</span>
<span class="nc" id="L106">                java.util.Base64.getUrlDecoder().decode(payload), </span>
                StandardCharsets.UTF_8
            );
            
            // Simple extraction - in production you might want to use a JSON parser
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (decodedPayload.contains(&quot;\&quot;dest\&quot;:&quot;)) {</span>
<span class="nc" id="L112">                int destStart = decodedPayload.indexOf(&quot;\&quot;dest\&quot;:\&quot;&quot;) + 8;</span>
<span class="nc" id="L113">                int destEnd = decodedPayload.indexOf(&quot;\&quot;&quot;, destStart);</span>
<span class="nc bnc" id="L114" title="All 4 branches missed.">                if (destStart &gt; 7 &amp;&amp; destEnd &gt; destStart) {</span>
<span class="nc" id="L115">                    String dest = decodedPayload.substring(destStart, destEnd);</span>
                    // Extract shop domain from URL
<span class="nc bnc" id="L117" title="All 2 branches missed.">                    if (dest.startsWith(&quot;https://&quot;)) {</span>
<span class="nc" id="L118">                        String domain = dest.substring(8);</span>
<span class="nc" id="L119">                        int slashIndex = domain.indexOf('/');</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                        if (slashIndex &gt; 0) {</span>
<span class="nc" id="L121">                            domain = domain.substring(0, slashIndex);</span>
                        }
<span class="nc" id="L123">                        return domain;</span>
                    }
                }
            }
            
<span class="nc" id="L128">            return null;</span>
<span class="nc" id="L129">        } catch (Exception e) {</span>
<span class="nc" id="L130">            log.debug(&quot;Error extracting shop domain from token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L131">            return null;</span>
        }
    }
    
    /**
     * Creates a JWT token for testing purposes.
     *
     * @param shop the shop domain
     * @param userId the user ID (optional)
     * @return the generated JWT token
     */
    public String createTestToken(String shop, Long userId) {
<span class="nc" id="L143">        SecretKey key = Keys.hmacShaKeyFor(context.getApiSecret().getBytes(StandardCharsets.UTF_8));</span>
        
<span class="nc" id="L145">        JwtBuilder builder = Jwts.builder()</span>
<span class="nc" id="L146">            .setIssuer(shop)</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            .setSubject(userId != null ? userId.toString() : &quot;1&quot;)</span>
<span class="nc" id="L148">            .setAudience(context.getApiKey())</span>
<span class="nc" id="L149">            .setIssuedAt(Date.from(Instant.now()))</span>
<span class="nc" id="L150">            .setExpiration(Date.from(Instant.now().plusSeconds(3600)))</span>
<span class="nc" id="L151">            .claim(&quot;dest&quot;, &quot;https://&quot; + shop)</span>
<span class="nc" id="L152">            .signWith(key, SignatureAlgorithm.HS256);</span>
            
<span class="nc bnc" id="L154" title="All 2 branches missed.">        if (userId != null) {</span>
<span class="nc" id="L155">            builder.claim(&quot;sub&quot;, userId.toString());</span>
        }
        
<span class="nc" id="L158">        return builder.compact();</span>
    }
    
    private void validateRequiredClaims(Claims claims) {
        // Validate issuer (shop domain)
<span class="nc" id="L163">        String issuer = claims.getIssuer();</span>
<span class="nc bnc" id="L164" title="All 4 branches missed.">        if (issuer == null || !issuer.endsWith(&quot;.myshopify.com&quot;)) {</span>
<span class="nc" id="L165">            throw new ShopifyApiException(&quot;Invalid or missing issuer claim&quot;);</span>
        }
        
        // Validate audience (API key)
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (claims.getAudience() == null || !claims.getAudience().contains(context.getApiKey())) {</span>
<span class="nc" id="L170">            throw new ShopifyApiException(&quot;Invalid audience claim&quot;);</span>
        }
        
        // Validate expiration
<span class="nc" id="L174">        Date expiration = claims.getExpiration();</span>
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if (expiration != null &amp;&amp; expiration.before(new Date())) {</span>
<span class="nc" id="L176">            throw new ShopifyApiException(&quot;Token has expired&quot;);</span>
        }
        
        // Validate issued at time (not too far in the future)
<span class="nc" id="L180">        Date issuedAt = claims.getIssuedAt();</span>
<span class="nc bnc" id="L181" title="All 4 branches missed.">        if (issuedAt != null &amp;&amp; issuedAt.after(new Date(System.currentTimeMillis() + 300000))) { // 5 minutes tolerance</span>
<span class="nc" id="L182">            throw new ShopifyApiException(&quot;Token issued too far in the future&quot;);</span>
        }
<span class="nc" id="L184">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>