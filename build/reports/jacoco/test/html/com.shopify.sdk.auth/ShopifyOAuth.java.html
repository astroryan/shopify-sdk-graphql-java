<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShopifyOAuth.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shopify-spring-sdk</a> &gt; <a href="index.source.html" class="el_package">com.shopify.sdk.auth</a> &gt; <span class="el_source">ShopifyOAuth.java</span></div><h1>ShopifyOAuth.java</h1><pre class="source lang-java linenums">package com.shopify.sdk.auth;

import com.shopify.sdk.config.ShopifyAuthContext;
import com.shopify.sdk.exception.ShopifyApiException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.web.util.UriComponentsBuilder;

import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.util.*;

/**
 * OAuth authentication helper for Shopify applications.
 */
<span class="fc" id="L21">@Slf4j</span>
@Component
<span class="fc" id="L23">@RequiredArgsConstructor</span>
public class ShopifyOAuth {
    
    private final ShopifyAuthContext context;
    
    /**
     * Generates the OAuth authorization URL for Shopify app installation.
     *
     * @param shop the shop domain
     * @param scopes the requested permission scopes
     * @param redirectUri the redirect URI
     * @param state optional state parameter for CSRF protection
     * @return the authorization URL
     */
    public String getAuthorizationUrl(String shop, List&lt;String&gt; scopes, String redirectUri, String state) {
<span class="fc" id="L38">        validateShopDomain(shop);</span>
        
<span class="fc" id="L40">        UriComponentsBuilder builder = UriComponentsBuilder</span>
<span class="fc" id="L41">            .fromHttpUrl(String.format(&quot;https://%s/admin/oauth/authorize&quot;, normalizeShopDomain(shop)))</span>
<span class="fc" id="L42">            .queryParam(&quot;client_id&quot;, context.getApiKey())</span>
<span class="fc" id="L43">            .queryParam(&quot;scope&quot;, String.join(&quot;,&quot;, scopes))</span>
<span class="fc" id="L44">            .queryParam(&quot;redirect_uri&quot;, redirectUri);</span>
        
<span class="pc bpc" id="L46" title="1 of 4 branches missed.">        if (state != null &amp;&amp; !state.trim().isEmpty()) {</span>
<span class="fc" id="L47">            builder.queryParam(&quot;state&quot;, state);</span>
        }
        
<span class="fc" id="L50">        return builder.build().toUriString();</span>
    }
    
    /**
     * Exchanges the authorization code for an access token.
     *
     * @param shop the shop domain
     * @param code the authorization code
     * @return the access token response
     */
    public AccessTokenResponse exchangeCodeForToken(String shop, String code) {
<span class="fc" id="L61">        validateShopDomain(shop);</span>
        
<span class="pc bpc" id="L63" title="2 of 4 branches missed.">        if (code == null || code.trim().isEmpty()) {</span>
<span class="nc" id="L64">            throw new ShopifyApiException(&quot;Authorization code cannot be null or empty&quot;);</span>
        }
        
        // This would typically make an HTTP request to Shopify's token endpoint
        // For now, we'll return a placeholder structure
<span class="fc" id="L69">        log.info(&quot;Exchanging authorization code for access token for shop: {}&quot;, shop);</span>
        
        // TODO: Implement actual HTTP request to /admin/oauth/access_token
<span class="fc" id="L72">        return AccessTokenResponse.builder()</span>
<span class="fc" id="L73">            .accessToken(&quot;placeholder_token&quot;)</span>
<span class="fc" id="L74">            .scope(&quot;read_products,write_products&quot;)</span>
<span class="fc" id="L75">            .build();</span>
    }
    
    /**
     * Validates the OAuth callback parameters.
     *
     * @param shop the shop domain
     * @param code the authorization code
     * @param hmac the HMAC signature
     * @param state the state parameter
     * @param queryParams all query parameters
     * @return true if valid, false otherwise
     */
    public boolean validateCallback(String shop, String code, String hmac, String state, Map&lt;String, String&gt; queryParams) {
        try {
            // Validate shop domain
<span class="fc" id="L91">            validateShopDomain(shop);</span>
            
            // Validate HMAC signature
<span class="fc bfc" id="L94" title="All 2 branches covered.">            if (!validateHmac(queryParams, hmac)) {</span>
<span class="fc" id="L95">                log.warn(&quot;Invalid HMAC signature for shop: {}&quot;, shop);</span>
<span class="fc" id="L96">                return false;</span>
            }
            
            // Validate code presence
<span class="pc bpc" id="L100" title="2 of 4 branches missed.">            if (code == null || code.trim().isEmpty()) {</span>
<span class="nc" id="L101">                log.warn(&quot;Missing authorization code for shop: {}&quot;, shop);</span>
<span class="nc" id="L102">                return false;</span>
            }
            
<span class="fc" id="L105">            return true;</span>
<span class="fc" id="L106">        } catch (Exception e) {</span>
<span class="fc" id="L107">            log.error(&quot;Error validating OAuth callback&quot;, e);</span>
<span class="fc" id="L108">            return false;</span>
        }
    }
    
    /**
     * Validates the HMAC signature of the request parameters.
     *
     * @param params the request parameters
     * @param receivedHmac the received HMAC signature
     * @return true if valid, false otherwise
     */
    public boolean validateHmac(Map&lt;String, String&gt; params, String receivedHmac) {
<span class="pc bpc" id="L120" title="2 of 4 branches missed.">        if (receivedHmac == null || receivedHmac.trim().isEmpty()) {</span>
<span class="nc" id="L121">            return false;</span>
        }
        
        try {
            // Remove hmac and signature from params for validation
<span class="fc" id="L126">            Map&lt;String, String&gt; filteredParams = new HashMap&lt;&gt;(params);</span>
<span class="fc" id="L127">            filteredParams.remove(&quot;hmac&quot;);</span>
<span class="fc" id="L128">            filteredParams.remove(&quot;signature&quot;);</span>
            
            // Build query string for HMAC calculation
<span class="fc" id="L131">            String queryString = buildQueryString(filteredParams);</span>
            
            // Calculate HMAC
<span class="fc" id="L134">            String calculatedHmac = calculateHmac(queryString, context.getApiSecret());</span>
            
<span class="fc" id="L136">            return receivedHmac.equals(calculatedHmac);</span>
<span class="nc" id="L137">        } catch (Exception e) {</span>
<span class="nc" id="L138">            log.error(&quot;Error validating HMAC&quot;, e);</span>
<span class="nc" id="L139">            return false;</span>
        }
    }
    
    /**
     * Validates a webhook request by verifying its HMAC signature.
     *
     * @param rawBody the raw request body
     * @param receivedHmac the received HMAC signature from header
     * @return true if valid, false otherwise
     */
    public boolean validateWebhook(String rawBody, String receivedHmac) {
<span class="pc bpc" id="L151" title="2 of 4 branches missed.">        if (receivedHmac == null || rawBody == null) {</span>
<span class="nc" id="L152">            return false;</span>
        }
        
        try {
            // Remove 'sha256=' prefix if present
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            String hmacToVerify = receivedHmac.startsWith(&quot;sha256=&quot;) </span>
<span class="nc" id="L158">                ? receivedHmac.substring(7) </span>
<span class="fc" id="L159">                : receivedHmac;</span>
                
<span class="fc" id="L161">            String calculatedHmac = calculateHmacSha256(rawBody, context.getWebhookSecret());</span>
            
<span class="fc" id="L163">            return hmacToVerify.equals(calculatedHmac);</span>
<span class="nc" id="L164">        } catch (Exception e) {</span>
<span class="nc" id="L165">            log.error(&quot;Error validating webhook HMAC&quot;, e);</span>
<span class="nc" id="L166">            return false;</span>
        }
    }
    
    private void validateShopDomain(String shop) {
<span class="fc bfc" id="L171" title="All 4 branches covered.">        if (shop == null || shop.trim().isEmpty()) {</span>
<span class="fc" id="L172">            throw new ShopifyApiException(&quot;Shop domain cannot be null or empty&quot;);</span>
        }
        
<span class="fc" id="L175">        String normalizedShop = normalizeShopDomain(shop);</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (!normalizedShop.endsWith(&quot;.myshopify.com&quot;)) {</span>
<span class="nc" id="L177">            throw new ShopifyApiException(&quot;Invalid shop domain: &quot; + shop);</span>
        }
<span class="fc" id="L179">    }</span>
    
    private String normalizeShopDomain(String shop) {
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        if (shop == null) {</span>
<span class="nc" id="L183">            return null;</span>
        }
        
<span class="fc" id="L186">        shop = shop.trim().toLowerCase();</span>
        
        // Remove protocol if present
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (shop.startsWith(&quot;https://&quot;)) {</span>
<span class="nc" id="L190">            shop = shop.substring(8);</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        } else if (shop.startsWith(&quot;http://&quot;)) {</span>
<span class="nc" id="L192">            shop = shop.substring(7);</span>
        }
        
        // Add .myshopify.com if not present
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (!shop.endsWith(&quot;.myshopify.com&quot;)) {</span>
<span class="nc" id="L197">            shop = shop + &quot;.myshopify.com&quot;;</span>
        }
        
<span class="fc" id="L200">        return shop;</span>
    }
    
    private String buildQueryString(Map&lt;String, String&gt; params) {
<span class="fc" id="L204">        return params.entrySet().stream()</span>
<span class="fc" id="L205">            .sorted(Map.Entry.comparingByKey())</span>
<span class="fc" id="L206">            .map(entry -&gt; {</span>
                try {
<span class="fc" id="L208">                    return URLEncoder.encode(entry.getKey(), StandardCharsets.UTF_8) + </span>
                           &quot;=&quot; + 
<span class="fc" id="L210">                           URLEncoder.encode(entry.getValue(), StandardCharsets.UTF_8);</span>
<span class="nc" id="L211">                } catch (Exception e) {</span>
<span class="nc" id="L212">                    throw new RuntimeException(&quot;Error encoding parameter&quot;, e);</span>
                }
            })
<span class="fc" id="L215">            .reduce((a, b) -&gt; a + &quot;&amp;&quot; + b)</span>
<span class="fc" id="L216">            .orElse(&quot;&quot;);</span>
    }
    
    private String calculateHmac(String data, String secret) throws NoSuchAlgorithmException, InvalidKeyException {
<span class="fc" id="L220">        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span>
<span class="fc" id="L221">        SecretKeySpec secretKeySpec = new SecretKeySpec(secret.getBytes(StandardCharsets.UTF_8), &quot;HmacSHA256&quot;);</span>
<span class="fc" id="L222">        mac.init(secretKeySpec);</span>
<span class="fc" id="L223">        byte[] digest = mac.doFinal(data.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L224">        return bytesToHex(digest);</span>
    }
    
    private String calculateHmacSha256(String data, String secret) throws NoSuchAlgorithmException, InvalidKeyException {
<span class="fc" id="L228">        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span>
<span class="fc" id="L229">        SecretKeySpec secretKeySpec = new SecretKeySpec(secret.getBytes(StandardCharsets.UTF_8), &quot;HmacSHA256&quot;);</span>
<span class="fc" id="L230">        mac.init(secretKeySpec);</span>
<span class="fc" id="L231">        byte[] digest = mac.doFinal(data.getBytes(StandardCharsets.UTF_8));</span>
<span class="fc" id="L232">        return Base64.getEncoder().encodeToString(digest);</span>
    }
    
    private String bytesToHex(byte[] bytes) {
<span class="fc" id="L236">        StringBuilder result = new StringBuilder();</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">        for (byte b : bytes) {</span>
<span class="fc" id="L238">            result.append(String.format(&quot;%02x&quot;, b));</span>
        }
<span class="fc" id="L240">        return result.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>